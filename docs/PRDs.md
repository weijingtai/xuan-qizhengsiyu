
# 七政四余排盘应用产品需求文档 (PRD)

## 1. 项目概述

本项目旨在开发一款名为“七政四余”的移动应用，为用户提供专业、准确的七政四余命盘排盘和分析工具。应用基于Flutter框架开发，支持多平台运行。

## 2. 功能需求

### 2.1 核心功能：排盘

- **输入信息**：
  - 用户需要能够输入公历或农历出生日期和时间。
  - 需要支持时区选择。
  - 需要输入性别。
  - 需要输入出生地点（用于经纬度校正）。
- **排盘计算**：
  - **天星位置计算**：精确计算太阳、月亮、金星、木星、水星、火星、土星（七政）以及罗睺、计都、紫气、月孛（四余）在黄道上的位置。
  - **命宫计算**：根据输入信息，确定命宫、身宫等十二宫的位置。
  - **神煞计算**：计算各种神煞（如天德、月德、羊刃、桃花等）的落宫。
  - **格局分析**：根据星体和宫位的组合，初步判断格局（例如，“日月合璧”、“五星连珠”等）。

### 2.1.1 技术性排盘需求

为了满足不同流派和研究需求，排盘计算需支持多种配置选项：

- **占星流派 (Schools)**:
  - 应用需支持至少两种主流派：**果老星宗 (`guoXue`)** 和 **天池 (`tianChi`)**。
  - 不同流派在部分星曜和神煞的计算上可能存在差异。

- **坐标与黄道系统 (Coordinate & Zodiac Systems)**:
  - 应用需内置多种星历计算体系，并允许用户切换。这体现在 `enum_panel_system_type.dart` 中定义的 `PanelSystemType`。
  - **黄道系统 (Ecliptic/Zodiac)**:
    - 现代回归黄道制 (`zodiacTropicalModern`)
    - 古典回归黄道制 (`zodiacTropicalClassic`)
    - 恒星黄道制 (`zodiacSidereal`)
    - 宋历恒星黄道制 (`songZodiacSidereal`)
  - **赤道系统 (Equatorial)**:
    - 恒星赤道制 (`equatorialSidereal`)
    - 汉历恒星赤道制 (`hanEquatorialSidereal`)
  - 应用必须包含在这些坐标系统之间进行转换的逻辑（如 `traditional_chinese_equatorial_to_ecliptic.dart` 所示）。

- **星体运动状态**:
  - 计算并展示星体的运行状态，是排盘的重要组成部分。
  - `star_angle_speed.dart` 模型用于描述星体的角速度。
  - 需要根据速度判断星体是 **顺行 (Direct)**、**逆行 (Retrograde)** 还是 **留 (Stationary)**，并在命盘上明确标识。
- **命盘展示**：
  - 以图形化的方式清晰展示命盘，包括十二宫、星体位置、神煞、以及各星体之间的角度关系。
  - 命盘需要美观、易于理解，符合传统星盘样式。
  - 支持命盘的缩放和拖动。

### 2.2 辅助功能

- **用户档案管理**：
  - 用户可以保存排盘记录，并为每个记录添加备注。
  - 支持对已保存记录的增、删、改、查。
- **大运流年**：
  - 基于已保存的命盘，计算并展示大运、小限、流年的运势走向。
  - `calculate_fate_dong_wei_usecase.dart` 表明了存在类似的复杂计算逻辑，用于推算运势。
- **数据持久化**：
  - 应用使用本地数据库（如 `app_database.dart` 中定义的 `drift` 数据库）来存储用户档案和排盘设置。
- **数据源**：
  - 应用内置了必要的数据，例如 `shen_sha_local_data_source.dart` 中定义的神煞信息，以支持离线排盘。

### 2.3 界面与体验

- **主题切换**：提供日间和夜间模式。
- **导航**：应用内导航应清晰、直观。`navigator.dart` 文件定义了应用的路由。
- **常量资源**：`qi_zheng_si_yu_constant_resources.dart` 和 `qi_zheng_si_yu_ui_constant_resources.dart` 定义了应用中使用的常量和UI资源，确保了应用的一致性。

## 3. 非功能性需求

- **性能**：排盘计算需要在几秒钟内完成，界面滚动和动画需要流畅。
- **准确性**：星历计算必须高度准确，符合天文数据。
- **兼容性**：应用应在主流的 iOS 和 Android 版本上稳定运行。
- **可维护性**：代码结构应清晰，遵循 Clean Architecture 原则（如 `domain`, `data`, `presentation` 的分层结构），便于后期维护和功能扩展。

## 4. 数据模型

- **核心模型**：`QiZhengSiYuPanModel.dart` 是核心数据模型，封装了排盘所需的所有信息，包括用户信息、星体位置、宫位信息等。
- **数据库表**：`app_database.dart` 中定义了数据库的表结构，用于持久化存储数据。

